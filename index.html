import React, { useState, useRef, useEffect } from 'react';
import { Slider } from '@/components/ui/slider';
import { Button } from '@/components/ui/button';
import { Download } from 'lucide-react';

const ImageTransformer = () => {
  const [imageSrc, setImageSrc] = useState(null);
  const [scale, setScale] = useState(1);
  const [rotation, setRotation] = useState(0);
  const [aspectRatio, setAspectRatio] = useState(1);
  const [cornerRadius, setCornerRadius] = useState(0);
  const canvasRef = useRef(null);

  // 画像を読み込む関数
  const handleImageUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => setImageSrc(e.target.result);
      reader.readAsDataURL(file);
    }
  };

  // Canvasに画像を描画し、変形する
  useEffect(() => {
    if (imageSrc && canvasRef.current) {
      const canvas = canvasRef.current;
      const ctx = canvas.getContext('2d');
      const img = new Image();
      img.src = imageSrc;
      img.onload = () => {
        // 画面をクリア
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 回転とスケールを適用
        ctx.save();
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate((rotation * Math.PI) / 180);
        ctx.scale(scale, scale * aspectRatio);
        
        // 角の丸みのためにパスを作成
        const width = img.width * scale;
        const height = img.height * scale * aspectRatio;
        ctx.beginPath();
        ctx.moveTo(-width / 2 + cornerRadius, -height / 2);
        ctx.lineTo(width / 2 - cornerRadius, -height / 2);
        ctx.quadraticCurveTo(width / 2, -height / 2, width / 2, -height / 2 + cornerRadius);
        ctx.lineTo(width / 2, height / 2 - cornerRadius);
        ctx.quadraticCurveTo(width / 2, height / 2, width / 2 - cornerRadius, height / 2);
        ctx.lineTo(-width / 2 + cornerRadius, height / 2);
        ctx.quadraticCurveTo(-width / 2, height / 2, -width / 2, height / 2 - cornerRadius);
        ctx.lineTo(-width / 2, -height / 2 + cornerRadius);
        ctx.quadraticCurveTo(-width / 2, -height / 2, -width / 2 + cornerRadius, -height / 2);
        ctx.clip();

        // 画像を描画
        ctx.drawImage(img, -width / 2, -height / 2, width, height);
        ctx.restore();
      };
    }
  }, [imageSrc, scale, rotation, aspectRatio, cornerRadius]);

  // 画像をダウンロードする関数
  const handleDownload = () => {
    const canvas = canvasRef.current;
    const link = document.createElement('a');
    link.href = canvas.toDataURL();
    link.download = 'transformed_image.png';
    link.click();
  };

  return (
    <div className="p-4 max-w-md mx-auto flex flex-col items-center">
      <input type="file" accept="image/*" onChange={handleImageUpload} className="mb-4" />
      <canvas ref={canvasRef} width={400} height={400} className="border" />

      {imageSrc && (
        <div className="w-full space-y-4 mt-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">拡大縮小率: {scale.toFixed(2)}</label>
            <Slider
              value={[scale]}
              onValueChange={(value) => setScale(value[0])}
              max={2}
              min={0.5}
              step={0.01}
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">回転角度: {rotation}°</label>
            <Slider
              value={[rotation]}
              onValueChange={(value) => setRotation(value[0])}
              max={360}
              min={0}
              step={1}
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">縦横比: {aspectRatio.toFixed(2)}</label>
            <Slider
              value={[aspectRatio]}
              onValueChange={(value) => setAspectRatio(value[0])}
              max={2}
              min={0.5}
              step={0.01}
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">角の丸み: {cornerRadius.toFixed(2)}</label>
            <Slider
              value={[cornerRadius]}
              onValueChange={(value) => setCornerRadius(value[0])}
              max={50}
              min={0}
              step={1}
            />
          </div>
          <Button onClick={handleDownload} className="w-full flex items-center justify-center">
            <Download className="mr-2 h-4 w-4" /> 画像をダウンロード
          </Button>
        </div>
      )}
    </div>
  );
};

export default ImageTransformer;
