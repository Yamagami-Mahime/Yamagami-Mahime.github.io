import React, { useState, useRef } from 'react';

const ImageTransformer = () => {
  const [image, setImage] = useState(null); // 画像データ
  const [vertices, setVertices] = useState(5); // 変形用の頂点数
  const [innerRadius, setInnerRadius] = useState(0.5); // 内側の半径
  const canvasRef = useRef(null); // Canvas参照用

  // 画像ファイルを読み込む
  const handleImageUpload = (event) => {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        setImage(img);
        drawImage(img);
      };
      img.src = reader.result;
    };
    if (file) {
      reader.readAsDataURL(file);
    }
  };

  // 画像をCanvasに描画する
  const drawImage = (img) => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    canvas.width = img.width;
    canvas.height = img.height;

    // 画像をCanvasに描画
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);

    // ここで変形ロジックを追加
    applyTransformation(ctx);
  };

  // 画像の変形処理
  const applyTransformation = (ctx) => {
    const width = ctx.canvas.width;
    const height = ctx.canvas.height;
    const centerX = width / 2;
    const centerY = height / 2;

    // 例: 変形する頂点数に基づいた処理（ここでは星形のマスク）
    ctx.beginPath();
    for (let i = 0; i < vertices * 2; i++) {
      const angle = (i / vertices) * Math.PI;
      const radius = i % 2 === 0 ? width * innerRadius : height / 2;
      const x = centerX + radius * Math.cos(angle);
      const y = centerY + radius * Math.sin(angle);
      if (i === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    }
    ctx.closePath();
    ctx.clip(); // 星形マスクを適用
    ctx.drawImage(image, 0, 0, width, height); // マスクされた領域に画像を再描画
  };

  return (
    <div className="p-4 max-w-md mx-auto">
      <div className="mb-4">
        <input type="file" accept="image/*" onChange={handleImageUpload} />
      </div>
      <div className="mb-4">
        <canvas ref={canvasRef} style={{ width: '100%', height: 'auto' }} />
      </div>
      <div className="w-full space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700">頂点の数: {vertices}</label>
          <input
            type="range"
            value={vertices}
            onChange={(e) => setVertices(Number(e.target.value))}
            max={12}
            min={3}
            step={1}
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700">内側の半径: {innerRadius.toFixed(2)}</label>
          <input
            type="range"
            value={innerRadius}
            onChange={(e) => setInnerRadius(Number(e.target.value))}
            max={1}
            min={0.1}
            step={0.01}
          />
        </div>
      </div>
    </div>
  );
};

export default ImageTransformer;
