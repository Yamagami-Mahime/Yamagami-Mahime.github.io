import React, { useState, useRef } from 'react';
import { Slider } from '@mui/material';
import { toPng } from 'html-to-image';
import { saveAs } from 'file-saver';

const ShapeDeformer = () => {
  const [selectedShape, setSelectedShape] = useState('blob'); // Default shape
  const [vertices, setVertices] = useState(10);
  const [cornerRadius, setCornerRadius] = useState(15);
  const [scale, setScale] = useState(50);
  const [angle, setAngle] = useState(90);
  const [verticalScale, setVerticalScale] = useState(50);
  const shapeRef = useRef(null);

  const shapes = [
    { id: 'blob', label: 'Blob' },
    { id: 'star', label: 'Star' },
    { id: 'ellipse', label: 'Ellipse' },
    { id: 'triangle', label: 'Triangle' },
    { id: 'diamond', label: 'Diamond' },
    { id: 'wave', label: 'Wave' },
  ];

  // Function to generate the SVG path based on selected shape and sliders
  const generateShapePath = () => {
    switch (selectedShape) {
      case 'blob':
        return `M50,100 C50,${cornerRadius},100,${cornerRadius},100,50 C100,${cornerRadius},${cornerRadius},${cornerRadius},${cornerRadius},50 Z`;
      case 'star':
        return `M50,15 L65,35 L85,35 L70,50 L75,70 L50,60 L25,70 L30,50 L15,35 L35,35 Z`;
      case 'ellipse':
        return `M50,${100 - scale} A${50},${25 + verticalScale} 0 1,1 50,${scale}`;
      case 'triangle':
        return `M50,15 L85,85 L15,85 Z`;
      case 'diamond':
        return `M50,15 L85,50 L50,85 L15,50 Z`;
      case 'wave':
        return `M0,50 Q20,${30 + scale},40,50 T80,50 T120,50 T160,50`;
      default:
        return '';
    }
  };

  const handleSavePng = () => {
    if (shapeRef.current === null) return;

    toPng(shapeRef.current)
      .then((dataUrl) => {
        saveAs(dataUrl, 'shape.png');
      })
      .catch((err) => {
        console.error('Error saving image', err);
      });
  };

  return (
    <div className="shape-deformer">
      {/* Shape Selection */}
      <div className="shape-selector">
        {shapes.map((shape) => (
          <button
            key={shape.id}
            className={`shape-button ${selectedShape === shape.id ? 'active' : ''}`}
            onClick={() => setSelectedShape(shape.id)}
          >
            {shape.label}
          </button>
        ))}
      </div>

      {/* Shape Display */}
      <div className="shape-display">
        <svg ref={shapeRef} width="200" height="200" viewBox="0 0 100 100">
          <path d={generateShapePath()} fill="none" stroke="black" strokeWidth="2" />
        </svg>
      </div>

      {/* Sliders for deformation */}
      <div className="controls">
        <div className="slider-control">
          <label>頂点の数: {vertices}</label>
          <Slider
            value={vertices}
            onChange={(e, val) => setVertices(val)}
            min={3}
            max={30}
          />
        </div>
        <div className="slider-control">
          <label>角の半径: {cornerRadius}px</label>
          <Slider
            value={cornerRadius}
            onChange={(e, val) => setCornerRadius(val)}
            min={0}
            max={50}
          />
        </div>
        <div className="slider-control">
          <label>オブジェクト比: {scale}%</label>
          <Slider
            value={scale}
            onChange={(e, val) => setScale(val)}
            min={0}
            max={100}
          />
        </div>
        <div className="slider-control">
          <label>角度: {angle}°</label>
          <Slider
            value={angle}
            onChange={(e, val) => setAngle(val)}
            min={0}
            max={180}
          />
        </div>
        <div className="slider-control">
          <label>縦横比: {verticalScale}%</label>
          <Slider
            value={verticalScale}
            onChange={(e, val) => setVerticalScale(val)}
            min={0}
            max={100}
          />
        </div>
      </div>

      {/* Save as PNG button */}
      <button onClick={handleSavePng} className="save-button">
        PNGで保存
      </button>
    </div>
  );
};

export default ShapeDeformer;
